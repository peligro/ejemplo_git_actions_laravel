name: Deploy Laravel to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Conectarse al EC2 mediante SSH
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/proyecto
            git pull origin main

            # Copiar .env si no existe
            if [ ! -f .env ]; then
              cp .env.example .env
            fi

            # Reemplazar variables
            sed -i "s|DB_HOST=.*|DB_HOST=${{ secrets.DB_HOST }}|" .env
            sed -i "s|DB_PORT=.*|DB_PORT=${{ secrets.DB_PORT }}|" .env
            sed -i "s|DB_DATABASE=.*|DB_DATABASE=${{ secrets.DB_DATABASE }}|" .env
            sed -i "s|DB_USERNAME=.*|DB_USERNAME=${{ secrets.DB_USERNAME }}|" .env
            sed -i "s|DB_PASSWORD=.*|DB_PASSWORD=${{ secrets.DB_PASSWORD }}|" .env
            sed -i "s|APP_KEY=.*|APP_KEY=${{ secrets.APP_KEY }}|" .env
            sed -i "s|APP_ENV=.*|APP_ENV=production|" .env
            sed -i "s|APP_DEBUG=.*|APP_DEBUG=false|" .env

            # ðŸ”¥ CORREGIR PERMISOS EN EL HOST ANTES DE LEVANTAR DOCKER
            sudo chown -R ubuntu:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            # Levantar contenedores
            docker-compose down --remove-orphans
            docker-compose up -d --build

            # Ejecutar migraciones
            docker exec peligro-laravel-app php artisan migrate --force